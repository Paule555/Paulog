<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#10B981">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Paulog">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Paulog</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;width:100%;background:#0F172A;color:#E2E8F0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;-webkit-font-smoothing:antialiased;overflow-x:hidden}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}
button{font-family:inherit;cursor:pointer}
.app{max-width:480px;margin:0 auto;min-height:100vh;padding-bottom:100px}
/* Header */
.hdr{padding:32px 20px 16px;text-align:center}
.hdr h1{font-size:32px;font-weight:800;letter-spacing:4px;color:#F8FAFC}
.hdr h1 span{color:#10B981}
.hdr p{font-size:13px;color:#64748B;margin-top:4px;letter-spacing:2px;text-transform:uppercase}
/* Stats */
.stats{display:flex;justify-content:center;align-items:center;gap:24px;padding:16px 20px;margin:0 20px 8px;background:#1E293B;border-radius:12px}
.stat{display:flex;flex-direction:column;align-items:center}
.stat-n{font-size:24px;font-weight:700;color:#F8FAFC}
.stat-l{font-size:11px;color:#64748B;text-transform:uppercase;letter-spacing:1px}
.stat-div{width:1px;height:32px;background:#334155}
/* Section */
.sec{padding:12px 20px}
.sec-t{font-size:13px;font-weight:600;color:#64748B;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px}
/* Day buttons */
.day-btn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:16px;margin-bottom:10px;background:#1E293B;border:none;border-radius:10px;text-align:left;color:#E2E8F0}
.day-btn .name{font-size:16px;font-weight:700}
.day-btn .musc{font-size:12px;color:#94A3B8;margin-top:2px}
.day-btn .arr{font-size:22px;font-weight:700}
.day-btn.sug{background:rgba(16,185,129,0.07)}
/* Bottom buttons */
.bbtn{padding:8px 20px;display:flex;flex-direction:column;gap:8px}
.sec-btn{width:100%;padding:14px;background:transparent;border:1px solid #334155;border-radius:10px;color:#94A3B8;font-size:15px;font-weight:600}
/* Track header */
.t-hdr{display:flex;align-items:center;gap:12px;padding:16px 20px;background:#1E293B;position:sticky;top:0;z-index:10}
.back{background:none;border:none;color:#94A3B8;font-size:24px;padding:4px 8px}
.t-hdr h2{font-size:18px;font-weight:700;color:#F8FAFC}
.t-hdr .sub{font-size:11px;color:#64748B}
.t-hdr .din{margin-left:auto;background:#0F172A;border:1px solid #334155;border-radius:8px;color:#E2E8F0;padding:6px 10px;font-size:13px;font-family:inherit}
/* Exercise cards */
.e-list{padding:8px 12px}
.e-card{margin-bottom:8px;border-radius:10px;overflow:hidden;background:#1E293B}
.e-hdr{display:flex;align-items:center;justify-content:space-between;width:100%;padding:14px;background:#1E293B;border:none;color:#E2E8F0;text-align:left}
.e-name{font-size:14px;font-weight:700}
.e-vol{font-size:11px;color:#94A3B8}
.e-vol .delta-up{color:#10B981;margin-left:4px}
.e-vol .delta-dn{color:#EF4444;margin-left:4px}
.e-icon{font-size:10px;color:#64748B}
.e-body{padding:0 14px 14px}
/* Prev session */
.prev{background:#0F172A;border-radius:8px;padding:8px 12px;margin-bottom:10px}
.prev-l{font-size:10px;color:#64748B;text-transform:uppercase;letter-spacing:1px}
.prev-s{display:flex;gap:8px;margin-top:4px;flex-wrap:wrap}
.prev-s span{font-size:12px;color:#94A3B8;background:#1E293B;padding:2px 8px;border-radius:4px}
/* Sets grid */
.s-grid{display:flex;flex-direction:column;gap:6px}
.s-hdr{display:grid;grid-template-columns:36px 1fr 1fr;gap:8px;margin-bottom:2px}
.s-hdr span{font-size:10px;color:#475569;text-align:center}
.s-row{display:grid;grid-template-columns:36px 1fr 1fr;gap:8px;align-items:center}
.s-num{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#FFF;font-weight:700;font-size:14px}
.s-inp{width:100%;padding:10px 8px;background:#0F172A;border:1px solid #334155;border-radius:8px;color:#F8FAFC;font-size:16px;text-align:center;font-weight:600;outline:none;font-family:inherit}
.s-inp:focus{border-color:#3B82F6}
/* Save button */
.save-btn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:calc(100% - 48px);max-width:440px;padding:16px;background:#3B82F6;border:none;border-radius:12px;color:#FFF;font-size:16px;font-weight:700;z-index:20;box-shadow:0 4px 24px rgba(59,130,246,0.4)}
/* History */
.h-hdr{display:flex;align-items:center;gap:12px;padding:16px 20px;background:#1E293B;position:sticky;top:0;z-index:10}
.h-hdr h2{font-size:18px;font-weight:700;color:#F8FAFC}
.h-cnt{margin-left:auto;font-size:12px;color:#64748B;background:#0F172A;padding:4px 10px;border-radius:12px}
.empty{text-align:center;padding:60px 20px}
.empty .ico{font-size:48px}
.empty .txt{font-size:16px;font-weight:600;color:#94A3B8;margin-top:12px}
.empty .sub{font-size:13px;color:#475569}
.mo-hdr{display:flex;justify-content:space-between;align-items:center;padding:12px 20px 6px;border-bottom:1px solid #1E293B}
.mo-hdr .name{font-size:14px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:1px}
.mo-hdr .cnt{font-size:11px;color:#475569}
.s-card{display:flex;margin:8px 12px;border-radius:10px;overflow:hidden;background:#1E293B}
.s-card .bar{width:4px;flex-shrink:0}
.s-card .cont{flex:1;padding:12px 14px}
.s-card .top{display:flex;justify-content:space-between;align-items:flex-start}
.s-card .day{font-size:14px;font-weight:700;color:#F8FAFC}
.s-card .date{font-size:12px;color:#64748B;margin-top:2px}
.s-card .sts{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.s-card .vol{font-size:13px;font-weight:700;color:#E2E8F0}
.s-card .exc{font-size:11px;color:#64748B}
.s-card .exs{margin-top:10px;padding-top:10px;border-top:1px solid #0F172A;display:flex;flex-direction:column;gap:4px}
.s-card .exr{display:flex;justify-content:space-between;align-items:center}
.s-card .exn{font-size:12px;color:#94A3B8}
.s-card .exd{font-size:11px;color:#64748B}
.s-card .acts{display:flex;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid #0F172A}
.act-edit{flex:1;padding:8px;background:#1E3A5F;border:none;border-radius:8px;color:#60A5FA;font-size:13px;font-weight:600}
.act-del{flex:1;padding:8px;background:#3B1C1C;border:none;border-radius:8px;color:#F87171;font-size:13px;font-weight:600}
.dc-bar{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid #0F172A}
.dc-txt{font-size:13px;color:#F87171;font-weight:600;flex:1}
.dc-yes{padding:8px 14px;background:#DC2626;border:none;border-radius:8px;color:#FFF;font-size:12px;font-weight:700}
.dc-no{padding:8px 14px;background:#334155;border:none;border-radius:8px;color:#94A3B8;font-size:12px;font-weight:600}
/* Dashboard */
.d-hdr{display:flex;align-items:center;gap:12px;padding:16px 20px;background:#1E293B;position:sticky;top:0;z-index:10}
.d-hdr h2{font-size:18px;font-weight:700;color:#F8FAFC}
.c-sec{padding:16px 20px;border-bottom:1px solid #1E293B}
.c-sec h3{font-size:16px;font-weight:700;margin:0 0 2px}
.c-sec .csub{font-size:11px;color:#64748B;margin:0 0 12px}
.c-wrap{background:#1E293B;border-radius:10px;padding:12px 8px}
.c-legend{padding:6px 0;line-height:1.8;display:flex;flex-wrap:wrap}
.c-legend span{display:inline-flex;align-items:center;gap:4px;margin-right:10px;font-size:10px;color:#94A3B8}
.c-legend .dot{width:8px;height:8px;border-radius:2px;display:inline-block}
.no-data{font-size:13px;color:#475569;font-style:italic}
.pb-sec{padding:16px 20px}
.pb-sec h3{font-size:16px;font-weight:700;margin-bottom:12px;color:#F8FAFC}
.pb-row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#1E293B;border-radius:8px;margin-bottom:6px}
.pb-left{display:flex;flex-direction:column;gap:2px}
.pb-row .ex{font-size:13px;color:#CBD5E1}
.pb-date{font-size:11px;color:#64748B}
.pb-row .kg{font-size:14px;font-weight:700;color:#F59E0B}
/* Backup */
.b-sec{padding:16px 20px;display:flex;flex-direction:column;gap:12px}
.b-card{background:#1E293B;border-radius:12px;padding:20px}
.b-card h3{font-size:15px;font-weight:700;color:#F8FAFC;margin-bottom:6px}
.b-card p{font-size:13px;color:#94A3B8;line-height:1.5;margin-bottom:12px}
.b-card .ld{font-size:12px;color:#64748B;margin-bottom:12px;font-style:italic}
.b-xbtn{width:100%;padding:12px;background:#3B82F6;border:none;border-radius:8px;color:#FFF;font-size:14px;font-weight:700}
.b-ibtn{display:block;width:100%;padding:12px;background:#1E3A5F;border:1px dashed #3B82F6;border-radius:8px;color:#60A5FA;font-size:14px;font-weight:600;text-align:center;cursor:pointer}
.b-cnf{background:#1E293B;border-radius:12px;padding:20px;border:1px solid #334155;display:flex;flex-direction:column;gap:8px}
.b-mrg{width:100%;padding:12px;background:#10B981;border:none;border-radius:8px;color:#FFF;font-size:14px;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:2px}
.b-rpl{width:100%;padding:12px;background:#F59E0B;border:none;border-radius:8px;color:#0F172A;font-size:14px;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:2px}
.b-bs{font-size:11px;font-weight:400;opacity:0.8}
.b-suc{padding:14px;background:#064E3B;border-radius:10px;color:#6EE7B7;font-size:14px;font-weight:600;text-align:center}
.b-err{padding:14px;background:#7F1D1D;border-radius:10px;color:#FCA5A5;font-size:14px;font-weight:600;text-align:center}
.b-inf{background:#1E293B;border-radius:12px;padding:16px;border:1px solid #334155}
.b-inf h3{font-size:13px;font-weight:700;color:#F8FAFC;margin-bottom:6px}
.b-inf p{font-size:13px;color:#94A3B8;line-height:1.5;margin:0}
/* Reminder */
.rem{margin:8px 20px 0;padding:14px 16px;background:#1E293B;border-radius:10px;border:1px solid rgba(245,158,11,0.2)}
.rem .rt{display:flex;align-items:center;gap:8px;font-size:13px;color:#F59E0B}
.rem .ra{display:flex;gap:8px;margin-top:10px}
.rem .rb{flex:1;padding:8px;background:#F59E0B;border:none;border-radius:8px;color:#0F172A;font-size:13px;font-weight:700}
.rem .rd{padding:8px 14px;background:transparent;border:1px solid #334155;border-radius:8px;color:#64748B;font-size:13px}
.hidden{display:none}
</style>
</head>
<body>
<div class="app" id="app"></div>
<script>
(function(){
"use strict";

var PLAN = {
  "Push": {muscles:"Brust / Schulter / Trizeps",color:"#3B82F6",exercises:["Bankdr√ºcken LH","Schulterdr√ºcken KH","Schr√§gbankdr√ºcken KH","Seitheben Kabel","Kabel Flys","Trizeps Pushdown Seil"]},
  "Pull": {muscles:"R√ºcken / Bizeps / hintere Schulter",color:"#10B981",exercises:["Latzug","T-Bar Row","Rudern Kabel eng","Reverse Fly Kabel","Langhantel Curls","Hammercurls KH"]},
  "Legs": {muscles:"Beine / Core",color:"#F59E0B",exercises:["Rum√§nisches Kreuzheben","Ausfallschritte KH","Beinstrecker Maschine","Beinbeuger Maschine","Wadenheben Maschine","Plank / Cable Crunch"]}
};
var SETS=4, SK="paulog-data", BK="paulog-bk", CC=["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899"];
var MN=["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
var DN=["So","Mo","Di","Mi","Do","Fr","Sa"];

// State
var state = {
  view:"home", day:null, date:today(), session:{}, expanded:null,
  editing:null, delConfirm:null, impStatus:null, impData:null, showRem:false
};
var allData = {};

// Storage
function load(){try{var r=localStorage.getItem(SK);return r?JSON.parse(r):{};}catch(e){return {};}}
function save(){try{localStorage.setItem(SK,JSON.stringify(allData));}catch(e){}}
function getLB(){try{return localStorage.getItem(BK)||null;}catch(e){return null;}}
function setLB(){try{localStorage.setItem(BK,today());}catch(e){}}
function daysBack(){var l=getLB();if(!l)return 9999;return Math.floor((new Date()-new Date(l+"T00:00:00"))/864e5);}

// Helpers
function today(){return new Date().toISOString().split("T")[0];}
function fmtDate(ds){var d=new Date(ds+"T00:00:00");return DN[d.getDay()]+", "+p2(d.getDate())+"."+p2(d.getMonth()+1)+"."+d.getFullYear();}
function p2(n){return n<10?"0"+n:""+n;}
function vol(sets){var s=0;for(var i=0;i<sets.length;i++)s+=(Number(sets[i].kg)||0)*(Number(sets[i].reps)||0);return s;}
function sugDay(){var w=new Date().getDay();if(w===1)return"Push";if(w===3)return"Pull";if(w===5)return"Legs";return null;}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function totalSess(){var t=0;for(var k in allData)t+=allData[k].length;return t;}

function getPB(){
  var pbs={};
  for(var k in allData){allData[k].forEach(function(s){for(var ex in s.exercises||{}){var mx=0;s.exercises[ex].forEach(function(st){var v=Number(st.kg)||0;if(v>mx)mx=v;});if(mx>0){if(!pbs[ex]||mx>pbs[ex].kg){pbs[ex]={kg:mx,date:s.date};}else if(mx===pbs[ex].kg&&s.date<pbs[ex].date){pbs[ex].date=s.date;}}}});}
  return pbs;
}

function getPrev(day,exercise){
  var dd=allData[day]||[];
  var sorted=dd.slice().sort(function(a,b){return b.date>a.date?1:b.date<a.date?-1:0;});
  for(var i=0;i<sorted.length;i++){
    if(sorted[i].date===state.date)continue;
    var ex=sorted[i].exercises&&sorted[i].exercises[exercise];
    if(ex&&ex.some(function(s){return s.kg||s.reps;}))return ex;
  }
  return null;
}

function getAllSess(){
  var ss=[];
  for(var day in allData)(allData[day]||[]).forEach(function(se){
    var tv=0,ec=0;
    for(var ex in se.exercises||{}){tv+=vol(se.exercises[ex]);if(se.exercises[ex].some(function(s){return s.kg||s.reps;}))ec++;}
    ss.push({day:day,date:se.date,totalVol:tv,exerciseCount:ec,exercises:se.exercises});
  });
  return ss.sort(function(a,b){return b.date>a.date?1:b.date<a.date?-1:0;});
}

function exportData(){
  var p={app:"paulog",version:1,exported:new Date().toISOString(),data:allData};
  var b=new Blob([JSON.stringify(p,null,2)],{type:"application/json"});
  var u=URL.createObjectURL(b);var a=document.createElement("a");a.href=u;a.download="paulog-backup-"+today()+".json";
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);setLB();
}

// Chart
function drawChart(day){
  var info=PLAN[day],sessions=(allData[day]||[]).slice().sort(function(a,b){return a.date>b.date?1:-1;});
  if(sessions.length===0)return'<p class="no-data">Noch keine Daten</p>';
  var data=sessions.map(function(s,i){var pt={name:"W"+(i+1)};info.exercises.forEach(function(ex){pt[ex]=s.exercises&&s.exercises[ex]?vol(s.exercises[ex]):0;});return pt;});
  var W=340,H=200,pl=45,pt2=20,pr=10,pb=30,cw=W-pl-pr,ch=H-pt2-pb;
  var allV=[];data.forEach(function(p){info.exercises.forEach(function(ex){if(p[ex])allV.push(p[ex]);});});
  var maxV=Math.max.apply(null,allV)||1;
  function x(i){return pl+(data.length===1?cw/2:(i/(data.length-1))*cw);}
  function y(v){return pt2+ch-(v/maxV)*ch;}

  var svg='<svg width="100%" viewBox="0 0 '+W+' '+H+'" style="max-width:'+W+'px">';
  // Grid
  for(var g=0;g<=4;g++){var gv2=g/4*maxV,gy=y(gv2);svg+='<line x1="'+pl+'" y1="'+gy+'" x2="'+(W-pr)+'" y2="'+gy+'" stroke="#334155" stroke-width="0.5"/>';svg+='<text x="'+(pl-5)+'" y="'+(gy+3)+'" fill="#64748B" font-size="9" text-anchor="end">'+Math.round(gv2)+'</text>';}
  // X labels
  data.forEach(function(p,i){svg+='<text x="'+x(i)+'" y="'+(H-5)+'" fill="#64748B" font-size="9" text-anchor="middle">'+p.name+'</text>';});
  // Lines
  info.exercises.forEach(function(ex,ei){
    var pts=[];data.forEach(function(p,i){if(p[ex])pts.push({x:x(i),y:y(p[ex])});});
    if(pts.length<1)return;
    var d=pts.map(function(p,i){return(i===0?"M":"L")+p.x.toFixed(1)+","+p.y.toFixed(1);}).join(" ");
    svg+='<path d="'+d+'" fill="none" stroke="'+CC[ei%6]+'" stroke-width="2" stroke-linejoin="round"/>';
    pts.forEach(function(p){svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="3" fill="'+CC[ei%6]+'"/>';});
  });
  svg+='</svg>';
  // Legend
  svg+='<div class="c-legend">';
  info.exercises.forEach(function(ex,i){svg+='<span><span class="dot" style="background:'+CC[i%6]+'"></span>'+esc(ex)+'</span>';});
  svg+='</div>';
  return svg;
}

// =========== RENDER ===========
function render(){
  var el=document.getElementById("app");
  var v=state.view;

  if(v==="home") el.innerHTML=renderHome();
  else if(v==="track") el.innerHTML=renderTrack();
  else if(v==="history") el.innerHTML=renderHistory();
  else if(v==="dashboard") el.innerHTML=renderDash();
  else if(v==="backup") el.innerHTML=renderBackup();

  bindEvents();
}

function renderHome(){
  var sug=sugDay(),ts=totalSess(),pbs=getPB(),pbCount=Object.keys(pbs).length;
  var h='<div class="hdr"><h1>Pau<span>log</span></h1><p>Push / Pull / Legs Tracker</p></div>';
  h+='<div class="stats"><div class="stat"><span class="stat-n">'+ts+'</span><span class="stat-l">Sessions</span></div><div class="stat-div"></div><div class="stat"><span class="stat-n">'+pbCount+'</span><span class="stat-l">√úbungen</span></div></div>';
  h+='<div class="sec"><h2 class="sec-t">Training starten</h2>';
  for(var day in PLAN){
    var info=PLAN[day],isSug=sug===day;
    h+='<button class="day-btn'+(isSug?' sug':'')+'" style="border-left:4px solid '+info.color+'" data-action="start" data-day="'+esc(day)+'">';
    h+='<div><div class="name">'+esc(day)+'</div><div class="musc">'+esc(info.muscles)+'</div></div>';
    h+='<div class="arr" style="color:'+info.color+'">‚Üí</div></button>';
  }
  h+='</div>';
  h+='<div class="bbtn"><button class="sec-btn" data-action="go" data-view="history">üìã Sessions verwalten</button>';
  h+='<button class="sec-btn" data-action="go" data-view="dashboard">üìä Dashboard</button>';
  h+='<button class="sec-btn" data-action="go" data-view="backup">üíæ Backup & Restore</button></div>';
  if(state.showRem&&ts>0){
    var lb=getLB();
    h+='<div class="rem"><div class="rt"><span>‚ö†Ô∏è</span><span>'+(lb?'Letztes Backup: '+fmtDate(lb):'Noch kein Backup!')+'</span></div>';
    h+='<div class="ra"><button class="rb" data-action="backup-now">Jetzt sichern</button><button class="rd" data-action="dismiss-rem">Sp√§ter</button></div></div>';
  }
  return h;
}

function renderTrack(){
  var info=PLAN[state.day],isEd=!!state.editing;
  var h='<div class="t-hdr" style="border-bottom:3px solid '+info.color+'">';
  h+='<button class="back" data-action="go" data-view="'+(isEd?'history':'home')+'">‚Üê</button>';
  h+='<div><h2>'+(isEd?'Session bearbeiten':esc(state.day))+'</h2><p class="sub">'+esc(info.muscles)+'</p></div>';
  h+='<input type="date" class="din" value="'+state.date+'" data-action="set-date"></div>';
  h+='<div class="e-list">';
  info.exercises.forEach(function(ex){
    var isX=state.expanded===ex,prev=getPrev(state.day,ex);
    var sets=state.session[ex]||[];
    var cv=vol(sets),pv=prev?vol(prev):0,hd=cv>0&&pv>0,delta=hd?Math.round(((cv-pv)/pv)*100):0;
    h+='<div class="e-card"><button class="e-hdr" style="border-left:3px solid '+info.color+'" data-action="toggle-ex" data-ex="'+esc(ex)+'">';
    h+='<div><span class="e-name">'+esc(ex)+'</span>';
    if(cv>0){h+='<div class="e-vol">Vol: '+cv.toLocaleString();if(hd)h+='<span class="'+(delta>=0?'delta-up':'delta-dn')+'">'+(delta>=0?'‚Üë':'‚Üì')+Math.abs(delta)+'%</span>';h+='</div>';}
    h+='</div><span class="e-icon">'+(isX?'‚ñ≤':'‚ñº')+'</span></button>';
    if(isX){
      h+='<div class="e-body">';
      if(prev){h+='<div class="prev"><span class="prev-l">Letzte Session:</span><div class="prev-s">';prev.forEach(function(s){if(s.kg||s.reps)h+='<span>'+esc(s.kg)+'kg√ó'+esc(s.reps)+'</span>';});h+='</div></div>';}
      h+='<div class="s-grid"><div class="s-hdr"><span></span><span>kg</span><span>Wdh</span></div>';
      sets.forEach(function(set,i){
        var phK=prev&&prev[i]?prev[i].kg||'‚Äî':'‚Äî';var phR=prev&&prev[i]?prev[i].reps||'‚Äî':'‚Äî';
        h+='<div class="s-row"><span class="s-num" style="background:'+info.color+'">'+(i+1)+'</span>';
        h+='<input type="number" inputmode="decimal" class="s-inp" placeholder="'+phK+'" value="'+esc(set.kg)+'" data-action="set-val" data-ex="'+esc(ex)+'" data-si="'+i+'" data-field="kg">';
        h+='<input type="number" inputmode="numeric" class="s-inp" placeholder="'+phR+'" value="'+esc(set.reps)+'" data-action="set-val" data-ex="'+esc(ex)+'" data-si="'+i+'" data-field="reps"></div>';
      });
      h+='</div></div>';
    }
    h+='</div>';
  });
  h+='</div>';
  h+='<button class="save-btn" data-action="save">'+(isEd?'‚úì √Ñnderungen speichern':'‚úì Session speichern')+'</button>';
  return h;
}

function renderHistory(){
  var sess=getAllSess(),grp={};
  sess.forEach(function(s){var m=s.date.slice(0,7);if(!grp[m])grp[m]=[];grp[m].push(s);});
  var h='<div class="h-hdr"><button class="back" data-action="go" data-view="home">‚Üê</button><h2>üìã Alle Sessions</h2><span class="h-cnt">'+sess.length+' gesamt</span></div>';
  if(sess.length===0){h+='<div class="empty"><p class="ico">üèãÔ∏è</p><p class="txt">Noch keine Sessions</p><p class="sub">Starte dein erstes Training!</p></div>';return h;}
  for(var mo in grp){
    var pts=mo.split("-");
    h+='<div class="mo-hdr"><span class="name">'+MN[parseInt(pts[1])-1]+' '+pts[0]+'</span><span class="cnt">'+grp[mo].length+' Sessions</span></div>';
    grp[mo].forEach(function(s){
      var inf=PLAN[s.day],isDel=state.delConfirm&&state.delConfirm.day===s.day&&state.delConfirm.date===s.date;
      h+='<div class="s-card"><div class="bar" style="background:'+(inf?inf.color:'#64748B')+'"></div><div class="cont">';
      h+='<div class="top"><div><div class="day">'+esc(s.day)+'</div><div class="date">'+fmtDate(s.date)+'</div></div>';
      h+='<div class="sts"><span class="vol">'+s.totalVol.toLocaleString()+' Vol</span><span class="exc">'+s.exerciseCount+' √úbungen</span></div></div>';
      h+='<div class="exs">';
      for(var ex in s.exercises||{}){var v=vol(s.exercises[ex]);if(v===0)continue;var mk=0;s.exercises[ex].forEach(function(st){var kk=Number(st.kg)||0;if(kk>mk)mk=kk;});h+='<div class="exr"><span class="exn">'+esc(ex)+'</span><span class="exd">'+mk+'kg ¬∑ '+v.toLocaleString()+' vol</span></div>';}
      h+='</div>';
      if(isDel){h+='<div class="dc-bar"><span class="dc-txt">Wirklich l√∂schen?</span><button class="dc-yes" data-action="del-confirm" data-day="'+esc(s.day)+'" data-date="'+esc(s.date)+'">Ja</button><button class="dc-no" data-action="del-cancel">Nein</button></div>';}
      else{h+='<div class="acts"><button class="act-edit" data-action="edit" data-day="'+esc(s.day)+'" data-date="'+esc(s.date)+'">‚úèÔ∏è Bearbeiten</button><button class="act-del" data-action="del-ask" data-day="'+esc(s.day)+'" data-date="'+esc(s.date)+'">üóë L√∂schen</button></div>';}
      h+='</div></div>';
    });
  }
  return h;
}

function renderDash(){
  var pbs=getPB();
  var h='<div class="d-hdr"><button class="back" data-action="go" data-view="home">‚Üê</button><h2>üìä Dashboard</h2></div>';
  for(var day in PLAN){
    var info=PLAN[day];
    h+='<div class="c-sec"><h3 style="color:'+info.color+'">'+esc(day)+'</h3><p class="csub">Volumen-Progression (kg √ó Wdh)</p><div class="c-wrap">'+drawChart(day)+'</div></div>';
  }
  var pbArr=[];for(var ex in pbs)if(pbs[ex].kg>0)pbArr.push([ex,pbs[ex].kg,pbs[ex].date]);
  pbArr.sort(function(a,b){return b[1]-a[1];});
  if(pbArr.length>0){
    h+='<div class="pb-sec"><h3>üèÜ Pers√∂nliche Bestleistungen</h3>';
    pbArr.forEach(function(p){h+='<div class="pb-row"><div class="pb-left"><span class="ex">'+esc(p[0])+'</span><span class="pb-date">'+fmtDate(p[2])+'</span></div><span class="kg">'+p[1]+' kg</span></div>';});
    h+='</div>';
  }
  return h;
}

function renderBackup(){
  var lb=getLB(),bts=totalSess();
  var h='<div class="d-hdr"><button class="back" data-action="go" data-view="home">‚Üê</button><h2>üíæ Backup & Restore</h2></div>';
  h+='<div class="b-sec">';
  h+='<div class="b-card"><h3>üì§ Exportieren</h3><p>Alle '+bts+' Sessions als Datei speichern.</p>';
  if(lb)h+='<p class="ld">Letztes Backup: '+fmtDate(lb)+'</p>';
  h+='<button class="b-xbtn" data-action="export"'+(bts===0?' disabled style="opacity:0.4"':'')+'>‚Üì Backup herunterladen</button></div>';
  h+='<div class="b-card"><h3>üì• Importieren</h3><p>Backup-Datei laden und wiederherstellen.</p>';
  h+='<label class="b-ibtn">‚Üë Datei ausw√§hlen<input type="file" accept=".json" data-action="import-file" style="display:none"></label></div>';
  if(state.impStatus==="confirm"&&state.impData){
    var ic=0;for(var k in state.impData)ic+=state.impData[k].length;
    h+='<div class="b-cnf"><h3>Import-Modus</h3><p>Datei enth√§lt '+ic+' Sessions.</p>';
    h+='<button class="b-mrg" data-action="imp-merge">üîÄ Zusammenf√ºhren<span class="b-bs">Bestehende behalten, neue hinzuf√ºgen</span></button>';
    h+='<button class="b-rpl" data-action="imp-replace">üîÑ Ersetzen<span class="b-bs">Alles √ºberschreiben</span></button>';
    h+='<button class="dc-no" data-action="imp-cancel">Abbrechen</button></div>';
  }
  if(state.impStatus==="success")h+='<div class="b-suc">‚úÖ Import erfolgreich!</div>';
  if(state.impStatus==="error")h+='<div class="b-err">‚ùå Ung√ºltige Datei</div>';
  h+='<div class="b-inf"><h3>üí° Tipp</h3><p>Backup regelm√§√üig in iCloud/Google Drive sichern. Erinnerung kommt alle 2 Wochen.</p></div></div>';
  return h;
}

// =========== EVENT HANDLING ===========
function bindEvents(){
  var app=document.getElementById("app");
  app.onclick=function(e){
    var t=e.target.closest("[data-action]");
    if(!t)return;
    var a=t.getAttribute("data-action");

    if(a==="go"){state.view=t.getAttribute("data-view");state.editing=null;state.delConfirm=null;render();}
    else if(a==="start"){initSession(t.getAttribute("data-day"),null,null);state.view="track";render();}
    else if(a==="toggle-ex"){var ex=t.getAttribute("data-ex");state.expanded=state.expanded===ex?null:ex;render();}
    else if(a==="save"){saveSession();render();}
    else if(a==="edit"){
      var day=t.getAttribute("data-day"),date=t.getAttribute("data-date");
      var sess=(allData[day]||[]).find(function(s){return s.date===date;});
      if(sess){state.editing={day:day,date:date};initSession(day,date,sess.exercises);state.view="track";render();}
    }
    else if(a==="del-ask"){state.delConfirm={day:t.getAttribute("data-day"),date:t.getAttribute("data-date")};render();}
    else if(a==="del-confirm"){
      var dy=t.getAttribute("data-day"),dt=t.getAttribute("data-date");
      allData[dy]=(allData[dy]||[]).filter(function(s){return s.date!==dt;});
      if(allData[dy].length===0)delete allData[dy];
      save();state.delConfirm=null;render();
    }
    else if(a==="del-cancel"){state.delConfirm=null;render();}
    else if(a==="export"){exportData();state.showRem=false;render();}
    else if(a==="backup-now"){exportData();state.showRem=false;render();}
    else if(a==="dismiss-rem"){state.showRem=false;render();}
    else if(a==="imp-merge"){doImport("merge");}
    else if(a==="imp-replace"){doImport("replace");}
    else if(a==="imp-cancel"){state.impStatus=null;state.impData=null;render();}
  };

  // Input changes (delegated)
  app.oninput=function(e){
    var t=e.target;
    if(t.getAttribute("data-action")==="set-val"){
      var ex=t.getAttribute("data-ex"),si=parseInt(t.getAttribute("data-si")),field=t.getAttribute("data-field");
      if(state.session[ex]&&state.session[ex][si])state.session[ex][si][field]=t.value;
      // Update volume display without full re-render
      updateVolDisplay(ex);
    }
    else if(t.getAttribute("data-action")==="set-date"){state.date=t.value;}
  };

  // File input
  var fi=app.querySelector("[data-action='import-file']");
  if(fi)fi.onchange=function(e){
    var f=e.target.files&&e.target.files[0];if(!f)return;
    var r=new FileReader();
    r.onload=function(ev){
      try{var p=JSON.parse(ev.target.result);var d=p.data||p;if(typeof d!=="object")throw 0;state.impData=d;state.impStatus="confirm";render();}
      catch(err){state.impStatus="error";render();setTimeout(function(){state.impStatus=null;render();},3000);}
    };
    r.readAsText(f);
  };
}

function updateVolDisplay(ex){
  // Lightweight vol update without full re-render
  var sets=state.session[ex]||[];
  var cv=vol(sets);
  // We can just let the next full render catch it ‚Äî inputs keep focus this way
}

function initSession(day,date,exData){
  state.day=day;state.date=date||today();
  if(exData){state.session=JSON.parse(JSON.stringify(exData));}
  else{
    var arr=allData[day]||[];
    var existing=arr.find(function(s){return s.date===state.date;});
    if(existing&&existing.exercises){state.session=JSON.parse(JSON.stringify(existing.exercises));}
    else{var se={};PLAN[day].exercises.forEach(function(e){se[e]=[];for(var i=0;i<SETS;i++)se[e].push({kg:"",reps:""});});state.session=se;}
  }
  state.expanded=PLAN[day].exercises[0];
}

function saveSession(){
  if(!allData[state.day])allData[state.day]=[];
  var idx=-1;
  for(var i=0;i<allData[state.day].length;i++){if(allData[state.day][i].date===state.date){idx=i;break;}}
  var entry={date:state.date,exercises:state.session};
  if(idx>=0)allData[state.day][idx]=entry;else allData[state.day].push(entry);
  save();state.editing=null;state.view="history";
}

function doImport(mode){
  if(mode==="replace"){allData=state.impData;}
  else{
    for(var day in state.impData){
      if(!allData[day])allData[day]=[];
      state.impData[day].forEach(function(s){
        var idx=-1;for(var i=0;i<allData[day].length;i++){if(allData[day][i].date===s.date){idx=i;break;}}
        if(idx>=0)allData[day][idx]=s;else allData[day].push(s);
      });
    }
  }
  save();state.impData=null;state.impStatus="success";render();
  setTimeout(function(){state.impStatus=null;render();},3000);
}

// Init
allData=load();
// Migrate old keys
var migrate={"Push (Mo)":"Push","Pull (Mi)":"Pull","Legs (Fr)":"Legs"};
var didMigrate=false;
for(var old in migrate){if(allData[old]){allData[migrate[old]]=(allData[migrate[old]]||[]).concat(allData[old]);delete allData[old];didMigrate=true;}}
if(didMigrate)save();
state.showRem=daysBack()>=14&&totalSess()>0;
render();

})();
</script>
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(function(){});}</script>
</body>
</html>
